---
output: 
html_document:
css: style.css
---

```{r setup, include=FALSE}
load_all()
library(pander)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('table.alignment.rownames', 'left')
panderOptions('keep.line.breaks', TRUE)
```

```{r load, include=F}
source("~/code/ssReports/scripts/load.R")
```

```{r met_summary, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/met_summary.R")
```

```{r teom_summary, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/teom_summary.R")
```

```{r flag_summary, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/flag_summary.R")
```

```{r find_events, echo=F, message=F, warning=F, results='hide'}
source("~/code/ssReports/scripts/events.R")
```

```{r met_table, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("## Data Summary - Meteorological Monitoring\n<br>") 
row_names <- c("Data Capture", "Monthly Mean", "Max Hour", "Min Hour")
col_names <- c("10m Wind\\\nSpeed (m/s)", "10m Wind\\\nDirection (deg)", 
               "Ambient\\\nTemp.(<sup>o</sup>C)", "Relative\\\nHumidity (%)", 
               "Delta Temp.\\\n2m (<sup>o</sup>C)", 
               "Delta Temp.\\\n10m (<sup>o</sup>C)", 
               "Net\\\nRadiation (W/m<sup>2</sup>)")
for (i in 1:length(met_summary)){
    rownames(met_summary[[i]]) <- row_names
    colnames(met_summary[[i]]) <- col_names
    cat("<body>")
    pandoc.table(met_summary[[i]], 
                 caption=cat(paste0("<h4> ", names(met_summary)[i], " </h4>")), 
                 split.table=Inf)
    cat("</body>")
}
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r teom_table, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("\n## Data Summary - Particulate Monitoring\n<br>")
for (i in names(teom_summary)){
    cat("<body>")
    pandoc.table(teom_summary[[i]], caption=cat("<h4>", i, "</h4>"), 
                 split.table=Inf)
    cat("</body>")
}
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r flags_events, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("\n## Data Review -  Flagged Data\n")
cat("\n##### (Flagged invalid hours, particulate monitoring)\n<br>")
cat("<p style=\"font-size: 8pt;\">")
pandoc.table(invalid_spread, split.table=Inf)
cat("</p>")

cat("\n## Site Exceedance Days\n")
cat("\n##### <a>Bold</a> values exceed allowable limit.\n<br>")
events[[3]] <- tag_value(events[[3]], "a", 150)
events[[4]] <- tag_value(events[[4]], "a", 35)
cat("<p style=\"font-size: 10pt;\">")
pandoc.table(events, split.table=Inf)
cat("</p>")
cat(" \n\n## Comments \n")
#cat("<div style=\"font-size: 10pt;\">")
comment_dir <- paste0("~/dropbox/salton/Salton Sea Field Operations/", 
                      "0_Level2/Monthly Reports/")
comment_file <- paste0(comment_dir, "comments_", month(start_date), 
                       year(start_date), ".txt")
    if (file.exists(comment_file)){
        for (i in 1:length(readLines(comment_file))){
            cat(" \n", readLines(comment_file)[i], " \n", sep="")
        }
    }
#cat("</div>")
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r event_pages, echo=F, results='asis', fig.height=4}
for (i in 1:length(event_list)){
    report_header(start_date, end_date, report_date)
    cat(paste0(" \n# Dust Event - ", 
               format(as.Date(names(event_list[i])), "%m-%d-%Y"), 
               " \n"))
    cat(" \n## Sites in Exceedance \n")
    cat("\n##### <a>Bold</a> values exceed allowable limit.\n")
    cat("<body>")
    pandoc.table(filter(events, Date==names(event_list)[i]), split.table=Inf)
    cat("</body>")
    cat(paste0("<p>![](", event_list[[i]]$time_img, ")</p>"))
    cat("<hr class=\"style2\">")
    cat(paste0("<p>![](", event_list[[i]]$photo_img, ")</p>"))
    cat("<hr class=\"style2\">")
    cat("<center>")
    print(event_list[[i]]$map)
    cat("</center>")
    cat("<p style=\"page-break-after:always;\"></p> \n")
}
```
