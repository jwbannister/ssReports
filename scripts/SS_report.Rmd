---
output: 
    html_document:
        css: style.css
---

```{r setup, include=FALSE}
load_all()
library(pander)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('table.alignment.rownames', 'left')
panderOptions('keep.line.breaks', TRUE)
```

```{r load, include=F}
source("~/code/ssReports/scripts/load.R")
```

```{r met_summary, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/met_summary.R")
```

```{r teom_summary, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/teom_summary.R")
```

```{r flag_summary, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/flag_summary.R")
```

```{r find_events, echo=F, message=F, results='hide'}
source("~/code/ssReports/scripts/events.R")
```

```{r met_table, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("## Data Summary - Meteorological Data\n") 
row_names <- c("Data Capture", "Monthly Mean", "Max Hour", "Min Hour")
col_names <- c("10m Wind Speed\n(m/s)", "Ambient Temp.\n(degC)", 
               "Relative Humidity\n(%)", "Delta Temp. 2m\n(degC)", 
               "Delta Temp. 10m\n(degC)")
for (i in 1:length(met_summary)){
    rownames(met_summary[[i]]) <- row_names
    colnames(met_summary[[i]]) <- col_names
    met_summary[[i]][1, ] <- paste0(as.numeric(met_summary[[i]][1 , ])*100, "%")
    cat("<body>")
    pandoc.table(met_summary[[i]], caption=names(met_summary)[i],
                 split.table=Inf)
    cat("</body>")
}
#cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r teom_table, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("\n## Data Summary - Particulate Concentration\n")
pandoc.table(pm10_tbl, caption="PM10", split.table=Inf)
pandoc.table(pm25_tbl, caption="PM2.5", split.table=Inf)
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r flags_events, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("\n## Data Review -  Flagged Data\n")
cat("\n(Total invalid hours during summary period)\n")

cat("<body>")
pandoc.table(invalid_spread, split.table=Inf)
cat("</body>")

cat("\n## Site Exceedance Days\n")
cat("<body>")
pandoc.table(events)
cat("</body>")
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r event_pages, echo=F, results='asis', fig.height=4}
for (i in 1:length(event_list)){
    report_header(start_date, end_date, report_date)
    cat(paste0(" \n# Dust Event - ", 
               format(as.Date(names(event_list[i])), "%m-%d-%Y"), 
               " \n"))
    cat(" \n## Sites in Exceedance \n")
    pandoc.table(filter(events, Date==names(event_list)[i]))
    cat(paste0("<p>![](", event_list[[i]]$time_img, ")</p>"))
    cat("<hr class=\"style2\">")
    cat(paste0("<p>![](", event_list[[i]]$photo_img, ")</p>"))
    cat("<hr class=\"style2\">")
    cat("<center>")
    print(event_list[[i]]$map)
    cat("</center>")
    cat("<p style=\"page-break-after:always;\"></p> \n")
}
```
