---
output: 
html_document:
css: style.css
---

```{r setup, include=FALSE}
load_all("~/code/ssReports")
load_all("~/code/Roses")
library(pander)
panderOptions('knitr.auto.asis', FALSE)
panderOptions('table.alignment.rownames', 'left')
panderOptions('keep.line.breaks', TRUE)
```

```{r load, include=F}
source("load.R")
```

```{r met_summary, echo=F, message=F, results='hide'}
source("met_summary.R")
```

```{r teom_summary, echo=F, message=F, results='hide'}
source("teom_summary.R")
```

```{r flag_summary, echo=F, message=F, results='hide'}
source("flag_summary.R")
```

```{r find_events, echo=F, message=F, warning=F, results='hide'}
source("events.R")
```

```{r met_table, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("## Data Summary - Meteorological Monitoring\n<br>") 
row_names <- c("Data Capture", "Monthly Mean", "Max Hour", "Min Hour")
col_names <- c("10m Wind\\\nSpeed (m/s)", "10m Wind\\\nDirection (deg)", 
               "Ambient\\\nTemp.(<sup>o</sup>C)", "Relative\\\nHumidity (%)", 
               "Delta Temp.\\\n2m (<sup>o</sup>C)", 
               "Delta Temp.\\\n10m (<sup>o</sup>C)", 
               "Net\\\nRadiation (W/m<sup>2</sup>)")
for (i in 1:length(met_summary)){
    rownames(met_summary[[i]]) <- row_names
    colnames(met_summary[[i]]) <- col_names
    cat("<body>")
    pandoc.table(met_summary[[i]], 
                 caption=cat(paste0("<h4> ", names(met_summary)[i], " </h4>")), 
                 split.table=Inf)
    cat("</body>")
}
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r teom_table, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("\n## Data Summary - Particulate Monitoring\n<br>")
for (i in names(teom_summary)){
    cat("<body>")
    pandoc.table(teom_summary[[i]], caption=cat("<h4>", i, "</h4>"), 
                 split.table=Inf)
    cat("</body>")
}
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r flags_events, echo=F, results='asis'}
report_header(start_date, end_date, report_date)
cat("\n## Data Review -  Flagged Data\n")
cat("\n##### (Flagged invalid hours, particulate monitoring. Invalid data flags may overlap in time.)\n<br>")
cat("<p style=\"font-size: 8pt;\">")
pandoc.table(invalid_spread, split.table=Inf)
cat("</p>")

cat("\n## Site Exceedance Days\n")
cat("\n##### <a>Bold</a> values exceed allowable limit.\n<br>")
events[[3]] <- tag_value(events[[3]], "a", 150)
events[[4]] <- tag_value(events[[4]], "a", 35)
cat("<p style=\"font-size: 10pt;\">")
pandoc.table(select(events, 1:4), split.table=Inf)
cat("</p>")
#cat("<div style=\"font-size: 10pt;\">")
gdrive_comments <- system(paste0(getwd(), "/gdrive list ", 
                  "-q \"'0B8qHESXOhs-DVmJjVTVxLXZvNms' in parents\""), intern=T)  
cmnt_fl <- tempfile()
write.table(gdrive_comments, file=cmnt_fl, quote=F, row.names=F, col.names=F)
comment_list <- read.table(cmnt_fl, header=F, skip=2)
comment_file <- paste0("comments_", month(start_date), year(start_date), ".txt")
    if (comment_file %in% comment_list[ , 2]){
        index <- which(comment_list[ , 2]==comment_file)
        system(paste0(getwd(), "/gdrive download --path ", tempdir(), " ", 
                      comment_list[ , 1][index]))
        if ((nrow(events) + 
             length(readLines(paste0(tempdir(), "/", comment_file)))) > 33){
            cat("<p style=\"page-break-after:always;\"></p> \n")
            report_header(start_date, end_date, report_date)
                 }
        cat(" \n\n## Comments \n")
        for (i in 1:length(readLines(paste0(tempdir(), "/", comment_file)))){
            cat(" \n", readLines(paste0(tempdir(), "/", comment_file))[i], 
                " \n", sep="")
        }
    }
#cat("</div>")
cat("<p style=\"page-break-after:always;\"></p> \n")
```

```{r event_pages, echo=F, results='asis', fig.height=3.5}
for (i in 1:length(event_list)){
    report_header(start_date, end_date, report_date)
    cat(paste0(" \n# Dust Event - ", 
               format(as.Date(names(event_list[i])), "%m-%d-%Y"), 
               " \n"))
    cat(" \n## Sites in Exceedance \n")
    cat("\n##### <a>Bold</a> values exceed allowable limit.\n")
    cat("<body>")
    pandoc.table(filter(select(events, 1:4), 
                        Date==names(event_list)[i]), split.table=Inf)
    cat("</body>")
    cat(paste0("<p>![](", event_list[[i]]$time_img, ")</p>"))
    cat("<hr class=\"style2\">")
    cat(paste0("<p>![](", event_list[[i]]$photo_img, ")</p>"))
    if (nrow(filter(select(events, 1:4), Date==names(event_list)[i])) < 4){
        cat("<hr class=\"style2\">")
    }
    cat("<center>")
    print(event_list[[i]]$map)
    cat("</center>")
    cat("<p style=\"page-break-after:always;\"></p> \n")
}
```
